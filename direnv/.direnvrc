source_up() {
  echo "source_up is insecure. Use source_up_secure instead." 1>&2
  exit 1
}

source_up_secure() {
  local hash=$1
  local file=$2
  local dir
  if [[ -z $file ]]; then
    file=.envrc
  fi
  dir=$(cd .. && find_up "$file")
  if [[ -n $dir ]]; then
    if ! echo "$hash $dir" | sha1sum -c --quiet - ; then
      echo "envrc file $dir does not match expected hash sum $hash" 1>&2
      exit 1
    fi
    source_env "$dir"
  fi
}
NIXPATH_add() {
  # Adds a path to the NIX_PATH
  # Although NIX_PATH looks similar to PATH, it's behaviour is different.
  # See https://nixos.org/nix/manual/#sec-common-env

  path_add NIX_PATH "$@"
}

use_nix() {
  local NIX_NO_WATCH_DEFAULT="${NIX_NO_WATCH_DEFAULT:false}"
  if [[ "$1" == "--no-watch-default" ]]; then
    NIX_NO_WATCH_DEFAULT="true"
    shift
  fi
  direnv_load nix-shell --show-trace "$@" --run "$(join_args "$direnv" dump)"
  if [[ "${NO_WATCH_DEFAULT:false}" == "false" ]]; then
    watch_file default.nix
    watch_file shell.nix
  fi
}
